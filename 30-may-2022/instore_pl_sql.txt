create table instore1(cust_id number,cust_name varchar(20),city varchar(20),store_name varchar(20));
INSERT INTO INSTORE1 (CUST_ID, CUST_NAME, CITY, STORE_NAME) VALUES ('1', 'TIM', 'BANGALORE', 'COSTA COFEE');
INSERT INTO INSTORE1 (CUST_ID, CUST_NAME, CITY, STORE_NAME) VALUES ('2', 'BIM', 'MANGALORE', 'BIG BAZAR');
INSERT INTO INSTORE1 (CUST_ID, CUST_NAME, CITY, STORE_NAME) VALUES ('3', 'RICK', 'TEXAS', 'MORE');
INSERT INTO INSTORE1 (CUST_ID, CUST_NAME, CITY, STORE_NAME) VALUES ('4', 'SMITH', 'LONDON', 'SHOPER STOP');

create table web_cust(cust_id number,cust_name varchar(20),cust_city varchar(20),email varchar(30),status varchar(20));
INSERT INTO WEB_CUST (CUST_ID, CUST_NAME, CUST_CITY, EMAIL, STATUS) VALUES ('11', 'RAM', 'KOLAR', 'RAM@GMAIL.COM', 'BOUNCED');
INSERT INTO WEB_CUST (CUST_ID, CUST_NAME, CUST_CITY, STATUS) VALUES ('12', 'SHAM', 'MYSORE', 'COMPLETED');
INSERT INTO WEB_CUST (CUST_ID, CUST_NAME, CUST_CITY, EMAIL, STATUS) VALUES ('13', 'SMITHA', 'TEXAS', 'SMITHA@GMAIL.COM', 'COMPLETED');
INSERT INTO WEB_CUST (CUST_ID, CUST_NAME, CUST_CITY, EMAIL, STATUS) VALUES ('14', 'SMITH', 'LONDON', 'SMITH@YAHOO.COM', 'PROCESSED'); 
INSERT INTO WEB_CUST (CUST_ID, CUST_NAME, CUST_CITY, EMAIL, STATUS) VALUES ('15', 'TIM', 'BANGALORE', 'TIM@YAHOO.COM', 'PROCESSED'); 

create table call_center_cust(cust_id number,cust_name varchar(20),city varchar(20),rep_name varchar(20),phone number);
INSERT INTO CALL_CENTER_CUST (CUST_ID, CUST_NAME, CITY, REP_NAME, PHONE) VALUES ('21', 'RAM', 'KOLAR', 'RAJESH', '8876543345');
INSERT INTO CALL_CENTER_CUST (CUST_ID, CUST_NAME, CITY, REP_NAME, PHONE) VALUES ('22', 'TIM', 'BANGALORE', 'RAMESH', '2323245678');
INSERT INTO CALL_CENTER_CUST (CUST_ID, CUST_NAME, CITY, REP_NAME) VALUES ('23', 'MICK', 'TEXAS', 'NASREEN');
INSERT INTO CALL_CENTER_CUST (CUST_ID, CUST_NAME, CITY, REP_NAME, PHONE) VALUES ('24', 'DAVID', 'MAGALORE', 'THRUPA', '4576988999'); 

CREATE TABLE TARGET_TABLE_CUST_DIM(cust_id number,cust_name varchar(20),city varchar(20),email varchar(30),phone number,rep_name varchar(20),SRC_CUST_ID NUMBER,SOURCE VARCHAR(20));
CREATE TABLE REJECT_CUST_TABLE(REJ_ID NUMBER,SRC_REC VARCHAR(20),REASON VARCHAR(100));

SELECT * FROM INSTORE1;
SELECT * FROM WEB_CUST;
SELECT * FROM CALL_CENTER_CUST;

SELECT CUST_ID,CUST_NAME,CITY,NULL,NULL,NULL,CUST_ID
FROM INSTORE1
UNION 
SELECT CUST_ID,CUST_NAME,CUST_CITY,EMAIL,NULL,NULL,CUST_ID
FROM WEB_CUST
UNION
SELECT CUST_ID,CUST_NAME,CITY,NULL,PHONE,REP_NAME,CUST_ID
FROM CALL_CENTER_CUST;

CREATE SEQUENCE SQ_REJ
START WITH 1
INCREMENT BY 1
MINVALUE 0
MAXVALUE 100
CYCLE
CACHE 5;

CREATE SEQUENCE SQ_TGT
START WITH 1
INCREMENT BY 1
MINVALUE 0
MAXVALUE 100
CYCLE
CACHE 5;


CREATE OR REPLACE PROCEDURE SP_INSTORE AS
CURSOR INS_CUR IS (SELECT *
                        FROM INSTORE1);
CURSOR WEB_CUR IS SELECT * FROM WEB_CUST;
CURSOR CALL_CUR IS SELECT * FROM CALL_CENTER_CUST;
VCNT NUMBER;
CNT NUMBER;
BEGIN
FOR I IN INS_CUR LOOP
    IF I.STORE_NAME IS NOT NULL THEN
        INSERT INTO TARGET_TABLE_CUST_DIM (CUST_ID,CUST_NAME,CITY,SRC_CUST_ID,SOURCE) 
            VALUES (SQ_TGT.NEXTVAL,I.CUST_NAME,I.CITY,I.CUST_ID,'INSTORE');
    END IF;
END LOOP;
FOR I IN CALL_CUR LOOP
    SELECT COUNT(*) INTO VCNT FROM TARGET_TABLE_CUST_DIM
        WHERE CUST_NAME=I.CUST_NAME AND CITY=I.CITY;
IF VCNT =1 THEN
    UPDATE TARGET_TABLE_CUST_DIM SET REP_NAME=I.REP_NAME,PHONE=I.PHONE WHERE 
        CUST_NAME=I.CUST_NAME AND CITY=I.CITY;
ELSE
    IF I.PHONE IS NOT NULL THEN 
     INSERT INTO TARGET_TABLE_CUST_DIM (CUST_ID,CUST_NAME,CITY,PHONE,REP_NAME,SRC_CUST_ID,SOURCE) VALUES
            (SQ_TGT.NEXTVAL,I.CUST_NAME,I.CITY,I.PHONE,I.REP_NAME,I.CUST_ID,'CALL');
    ELSE
        INSERT INTO REJECT_CUST_TABLE VALUES(SQ_REJ.NEXTVAL,I.CUST_ID,'PHONE IS NOT THERE');
    END IF;
END IF;
END LOOP;

FOR I IN WEB_CUR LOOP
    SELECT COUNT(*) INTO CNT FROM TARGET_TABLE_CUST_DIM
        WHERE CUST_NAME=I.CUST_NAME AND CITY=I.CUST_CITY;
IF CNT=1 THEN
    UPDATE TARGET_TABLE_CUST_DIM SET EMAIL=I.EMAIL WHERE CUST_NAME=I.CUST_NAME AND CITY=I.CUST_CITY;
ELSE
    IF I.STATUS NOT IN ('BOUNCED') THEN
        IF I.EMAIL LIKE '%@%' THEN
            INSERT INTO TARGET_TABLE_CUST_DIM(CUST_ID,CUST_NAME,CITY,EMAIL,SRC_CUST_ID,SOURCE) VALUES
                (SQ_TGT.NEXTVAL,I.CUST_NAME,I.CUST_CITY,I.EMAIL,I.CUST_ID,'WEB_CUST');
        END IF;
    END IF;
    IF I.EMAIL IS NULL THEN
        INSERT INTO REJECT_CUST_TABLE VALUES(SQ_REJ.NEXTVAL,I.CUST_ID,'EMAIL NOT');
    END IF;
END IF;
END LOOP;
END;

EXEC SP_INSTORE;

SELECT * FROM TARGET_TABLE_CUST_DIM;

SELECT * FROM REJECT_CUST_TABLE;

TRUNCATE TABLE TARGET_TABLE_CUST_DIM;
TRUNCATE TABLE REJECT_CUST_TABLE;

COMMIT;