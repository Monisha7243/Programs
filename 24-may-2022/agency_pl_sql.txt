create table agency_src		
(agency varchar(30),		
program_name varchar(30),		
fiscal_year int,		
original_appr_amount numeric);

create table agency_tgt	
(agency varchar (30),	
program_name varchar(30),	
fiscal_year int,	
Original_appr_amount NUMBER(10),	
program_amount NUMBER(10),	
agency_amount NUMBER(10),	
total_amount NUMBER(10));

INSERT INTO AGENCY_SRC VALUES('Education','High School Grant',2005,350000);
INSERT INTO AGENCY_SRC VALUES('Education','Middle School Grant',2005,50000);
INSERT INTO AGENCY_SRC VALUES('Education','High School Grant',2004,250000);
INSERT INTO AGENCY_SRC VALUES('DEP','Air',2005,50000);
INSERT INTO AGENCY_SRC VALUES('DEP','Air',2004,60000);
INSERT INTO AGENCY_SRC VALUES('DEP','Water',2005,70000);

COMMIT;

SELECT * FROM AGENCY_SRC;
SELECT * FROM agency_tgt;

CREATE OR REPLACE PROCEDURE AGENCY_SP AS
CURSOR AGENCY IS (SELECT AGENCY,PROGRAM_NAME,FISCAL_YEAR,ORIGINAL_APPR_AMOUNT
                                FROM AGENCY_SRC);

CURSOR PRG_AMT IS SELECT SUM(ORIGINAL_APPR_AMOUNT)SUM_PRG,PROGRAM_NAME
                        FROM AGENCY_SRC
                        GROUP BY PROGRAM_NAME;
                        
CURSOR AGENCY_AMT IS SELECT SUM(ORIGINAL_APPR_AMOUNT)SUM_AGEN,AGENCY
                        FROM AGENCY_SRC
                        GROUP BY AGENCY;
V_CNT NUMBER;
CNT NUMBER;
BEGIN 
FOR I IN AGENCY LOOP
    SELECT COUNT(*) INTO CNT 
        FROM AGENCY_TGT
        WHERE AGENCY=I.AGENCY AND PROGRAM_NAME=I.PROGRAM_NAME AND FISCAL_YEAR=I.FISCAL_YEAR AND 
       ORIGINAL_APPR_AMOUNT=I.ORIGINAL_APPR_AMOUNT ;
    IF CNT=0 THEN
        SELECT SUM(ORIGINAL_APPR_AMOUNT) INTO V_CNT 
            FROM AGENCY_SRC;
        INSERT INTO AGENCY_TGT VALUES(I.AGENCY,I.PROGRAM_NAME,I.FISCAL_YEAR,I.ORIGINAL_APPR_AMOUNT,
         0,0,V_CNT);
    END IF;
END LOOP;
FOR I IN PRG_AMT LOOP
    IF CNT=0 THEN
        UPDATE AGENCY_TGT SET PROGRAM_AMOUNT=I.SUM_PRG WHERE PROGRAM_NAME=I.PROGRAM_NAME;
END IF;
END LOOP;
FOR I IN AGENCY_AMT LOOP
    IF CNT=0 THEN
        UPDATE AGENCY_TGT SET AGENCY_AMOUNT=I.SUM_AGEN WHERE AGENCY=I.AGENCY;
END IF;
END LOOP;
END;

EXEC AGENCY_SP;

SELECT * FROM AGENCY_TGT;